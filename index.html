<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MaruyaTV — IPTV Player</title>

<!-- JW Player -->
<script src="https://ssl.p.jwpcdn.com/player/v/8.36.6/jwplayer.js"></script>
<script>jwplayer.key = "ITWMv7t88JGzI0xPwW8I0+LveiXX9SWbfdmt0ArUSyc=";</script>

<!-- Channels -->
<script src="channels.js"></script>

<style>
  :root {
    --bg:#0f2430; --muted:#9aa4b2;
    --accent:#7b6cff; --accent-2:#60a5fa; --sidebar-width:300px;
  }
  html,body {height:100%;margin:0;background:var(--bg);color:#e6eef6;font-family:Inter,system-ui,sans-serif;}
  .root {height:100vh;display:flex;gap:18px;padding:18px;box-sizing:border-box;}
  .sidebar {width:var(--sidebar-width);min-width:220px;background:#142436;border-radius:12px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,0.45);display:flex;flex-direction:column;gap:12px;}
  .sidebar h2 {margin:0;color:#9db0ff;font-size:20px;}
  .search input, .sidebar select {
    width:100%;padding:10px 12px;border-radius:8px;
    border:1px solid rgba(255,255,255,0.03);
    background:rgba(255,255,255,0.02);
    color:inherit;outline:none;
    margin-bottom:6px;
  }
  .channel-list {flex:1 1 auto;overflow:auto;padding-right:6px;}
  .channel-item {display:flex;gap:12px;align-items:center;padding:10px;border-radius:8px;cursor:pointer;transition: background .12s, transform .08s;margin-bottom:8px;}
  .channel-item:hover {transform:translateY(-3px);background:rgba(255,255,255,0.02);}
  .channel-item.active {background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#052430;font-weight:700;}
  .ch-logo {width:56px;height:36px;border-radius:6px;background:#0b1b25;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
  .ch-logo img {width:100%;height:100%;object-fit:cover}
  .ch-meta .name {font-weight:600;font-size:14px}
  .ch-meta .sub {font-size:12px;color:var(--muted)}
  .main {flex:1 1 auto;display:flex;flex-direction:column;gap:12px;min-width:0;}
  .player-card {background:#122534;border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,0.45);display:flex;gap:16px;flex-direction:column;}
  .player-wrap {position:sticky;top:18px;display:flex;gap:16px;align-items:flex-start;}
  .video {flex:1 1 auto;background:#1b2326;border-radius:8px;min-height:360px;overflow:hidden;position:relative;}
  #jwplayer-container {width:100%;height:100%;min-height:360px;}
  #fallbackMessage {display:none;position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);color:#fff;font-size:18px;display:flex;align-items:center;justify-content:center;text-align:center;}
  .player-info {width:320px;min-width:220px;max-width:360px;display:flex;flex-direction:column;gap:8px;}
  .now-title {font-weight:800;font-size:18px;margin:0;color:#dfe9ff;}
  .now-sub {color:var(--muted);font-size:13px;margin:0;}
  .epg {background:#0f1b22;border-radius:10px;padding:12px;height:calc(100vh - 520px);overflow:auto;}
  .epg h4 {margin:0 0 8px 0;color:#bfcfff}
  #status {color:var(--muted);font-size:13px;padding-left:4px;}
  #clock {color:#9db0ff;font-weight:600;text-align:right;font-size:14px;}
</style>
</head>
<body>
<div class="root">
  <aside class="sidebar">
    <h2>Channels</h2>
    <select id="categoryFilter">
      <option value="all">All Categories</option>
    </select>
    <div class="search"><input id="searchInput" placeholder="Search channels..." /></div>
    <div id="channelCount" style="font-size:12px;color:var(--muted)">Total Channels: 0</div>
    <div class="channel-list" id="channelList"></div>
  </aside>
  <main class="main">
    <section class="player-card">
      <div class="player-wrap">
        <div class="video">
          <div id="jwplayer-container"></div>
          <div id="fallbackMessage">Playback failed. Please try another channel.</div>
        </div>
        <div class="player-info">
          <div id="clock">--:--:--</div>
          <div class="now-meta">
            <div id="nowTitle" class="now-title">—</div>
            <div id="nowSub" class="now-sub">Select a channel from the left</div>
          </div>
          <div style="flex:1"></div>
          <div id="status">Ready.</div>
        </div>
      </div>
      <div class="epg" id="epgList"><h4>Now & Next</h4></div>
    </section>
  </main>
</div>

<script>
'use strict';
const PROXY_BASE = "https://maruya-reactapp.vercel.app/api/proxy?url=";
let jwPlayerInstance = null;
let activeChannelName = null;

function status(msg){document.getElementById('status').innerText=msg;console.log('[IPVTV]',msg);}
function escapeHtml(s){return String(s||'').replace(/[&<>"'`=\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#47;','=':'&#61;','`':'&#96;'}[c]));}
function safeLogo(url){if(!url) return null;if(url.startsWith("http://")) url=url.replace("http://","https://");return url;}

function updateClock(){
  const now=new Date();
  let hours=now.getHours();
  const minutes=String(now.getMinutes()).padStart(2,'0');
  const seconds=String(now.getSeconds()).padStart(2,'0');
  const ampm=hours>=12?'PM':'AM';
  hours=hours%12||12;
  document.getElementById('clock').textContent=`${String(hours).padStart(2,'0')}:${minutes}:${seconds} ${ampm}`;
}

function populateCategoryDropdown(){
  const categorySelect=document.getElementById('categoryFilter');
  const categories=Array.from(new Set(channels.map(c=>c.category).filter(Boolean))).sort();
  categories.forEach(cat=>{
    const option=document.createElement('option');
    option.value=cat;
    option.textContent=cat;
    categorySelect.appendChild(option);
  });
}

function buildChannelList(){
  const list=document.getElementById('channelList');
  const countDisplay=document.getElementById('channelCount');
  const search=document.getElementById('searchInput').value.toLowerCase();
  const selectedCategory=document.getElementById('categoryFilter').value;
  list.innerHTML='';
  let visibleCount=0;
  [...channels].sort((a,b)=>a.name.localeCompare(b.name)).forEach((ch,idx)=>{
    const matchCategory=selectedCategory==='all'||ch.category===selectedCategory;
    const matchSearch=ch.name.toLowerCase().includes(search);
    if(matchCategory&&matchSearch){
      visibleCount++;
      const item=document.createElement('div');item.className='channel-item';item.dataset.idx=idx;
      if(ch.name===activeChannelName) item.classList.add('active');
      const logoWrap=document.createElement('div');logoWrap.className='ch-logo';
      if(ch.logo){
        const img=document.createElement('img');img.src=safeLogo(ch.logo);img.alt=ch.name;
        img.onerror=function(){this.onerror=null;this.src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="320" height="180"><rect width="100%" height="100%" fill="%230b1b25"/><text x="50%" y="50%" fill="%239aa4b2" font-size="18" font-family="sans-serif" dominant-baseline="middle" text-anchor="middle">No logo</text></svg>';};
        logoWrap.appendChild(img);
      } else {logoWrap.textContent=ch.name.split(' ').slice(-1)[0];}
      const meta=document.createElement('div');meta.className='ch-meta';
      meta.innerHTML=`<div class="name">${escapeHtml(ch.name)}</div><div class="sub">${escapeHtml(ch.group||'Live')}${ch.license?' • DRM':''}</div>`;
      item.appendChild(logoWrap);item.appendChild(meta);
      item.onclick=()=>loadChannelByName(ch.name);
      list.appendChild(item);
    }
  });
  countDisplay.textContent=`Total Channels: ${visibleCount}`;
}

function initPlayer(){
  jwPlayerInstance=jwplayer("jwplayer-container").setup({
    width:"100%",height:"100%",
    autostart:false,stretching:"uniform",aspectratio:"16:9",
    primary:"html5",displaytitle:false
  });
  jwPlayerInstance.on('error',()=>showFallbackMessage());
  jwPlayerInstance.on('play',()=>hideFallbackMessage());
}

function loadChannelByName(name){
  const ch=channels.find(c=>c.name===name);
  if(!ch) return;
  activeChannelName=name;
  buildChannelList();
  document.getElementById('nowTitle').textContent=ch.name;
  document.getElementById('nowSub').textContent=(ch.group?ch.group+' • ':'')+ch.mpd;
  hideFallbackMessage();
  const streamUrl=PROXY_BASE+encodeURIComponent(ch.mpd);
  const drmConfig=ch.license?{widevine:{url:PROXY_BASE+encodeURIComponent(ch.license)}}:{};
  jwPlayerInstance.setup({
    file:streamUrl,
    type:"dash",
    drm:drmConfig,
    preload:"auto",
    width:"100%",
    height:"100%",
    stretching:"uniform",
    autostart:true
  });
  status(`Playing: ${ch.name}`);
}

function showFallbackMessage(){document.getElementById('fallbackMessage').style.display='flex';}
function hideFallbackMessage(){document.getElementById('fallbackMessage').style.display='none';}

window.addEventListener('load',()=>{
  initPlayer();
  populateCategoryDropdown();
  buildChannelList();
  updateClock();
  setInterval(updateClock,1000);
  if(channels&&channels.length>0){loadChannelByName(channels[0].name);}
});

document.getElementById('searchInput').oninput=buildChannelList;
document.getElementById('categoryFilter').onchange=buildChannelList;
document.addEventListener('contextmenu',e=>e.preventDefault());
</script>
</body>
</html>
