<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>IPVTV — JW Player + Proxy</title>

<!-- JW Player -->
<script src="https://ssl.p.jwpcdn.com/player/v/8.36.6/jwplayer.js"></script>
<script>jwplayer.key = "ITWMv7t88JGzI0xPwW8I0+LveiXX9SWbfdmt0ArUSyc=";</script>

<!-- Channels -->
<script src="channels.js"></script>

<style>
  :root{
    --bg:#0f2430; --muted:#9aa4b2;
    --accent:#7b6cff; --accent-2:#60a5fa; --sidebar-width:300px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#e6eef6;font-family:Inter,system-ui,sans-serif;}
  .root{height:100vh;display:flex;gap:18px;padding:18px;box-sizing:border-box;}
  .sidebar{width:var(--sidebar-width);min-width:220px;background:#142436;border-radius:12px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,0.45);display:flex;flex-direction:column;gap:12px;}
  .sidebar h2{margin:0;color:#9db0ff;font-size:20px;}
  .search input{width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background: rgba(255,255,255,0.02);color:inherit;outline:none;}
  .channel-list{flex:1 1 auto;overflow:auto;padding-right:6px;}
  .channel-item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:8px;cursor:pointer;transition: background .12s, transform .08s;margin-bottom:8px;}
  .channel-item:hover{transform: translateY(-3px); background: rgba(255,255,255,0.02);}
  .channel-item.active{ background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:#052430; font-weight:700; }
  .ch-logo{ width:56px; height:36px; border-radius:6px; background:#0b1b25; display:flex;align-items:center;justify-content:center; overflow:hidden; border:1px solid rgba(255,255,255,0.03) }
  .ch-logo img{ width:100%; height:100%; object-fit:cover }
  .ch-meta .name{ font-weight:600; font-size:14px }
  .ch-meta .sub{ font-size:12px; color:var(--muted) }
  .main{flex:1 1 auto;display:flex;flex-direction:column;gap:12px;min-width:0;}
  .player-card{background:#122534;border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,0.45);display:flex;gap:16px;flex-direction:column;}
  .player-wrap{position:sticky;top:18px;display:flex;gap:16px;align-items:flex-start;}
  .video{flex:1 1 auto;background:#1b2326;border-radius:8px;min-height:360px;overflow:hidden;}
  #jwplayer-container{width:100%;height:100%;min-height:360px;}
  .player-info{width:320px;min-width:220px;max-width:360px;display:flex;flex-direction:column;gap:8px;}
  .now-title{font-weight:800;font-size:18px;margin:0;color:#dfe9ff;}
  .now-sub{color:var(--muted);font-size:13px;margin:0;}
  .epg{background:#0f1b22;border-radius:10px;padding:12px;height: calc(100vh - 520px);overflow:auto;}
  .epg h4{margin:0 0 8px 0;color:#bfcfff}
  .epg-item{display:flex;justify-content:space-between;gap:12px;padding:8px;border-radius:8px;align-items:center;margin-bottom:8px;}
  .epg-item .title{font-weight:700;}
  .epg-item .time{color:var(--muted);font-size:12px}
  #status{ color:var(--muted); font-size:13px; padding-left:4px; }
</style>
</head>
<body>
<div class="root">
  <aside class="sidebar">
    <h2>Channels</h2>
    <div class="search"><input id="search" placeholder="Search channels..." /></div>
    <div class="channel-list" id="channelList"></div>
  </aside>
  <main class="main">
    <section class="player-card">
      <div class="player-wrap">
        <div class="video"><div id="jwplayer-container"></div></div>
        <div class="player-info">
          <div class="now-meta">
            <div id="nowTitle" class="now-title">—</div>
            <div id="nowSub" class="now-sub">Select a channel from the left</div>
          </div>
          <div style="flex:1"></div>
          <div id="status">Ready.</div>
        </div>
      </div>
      <div class="epg" id="epgList"><h4>Now & Next</h4></div>
    </section>
  </main>
</div>

<script>
'use strict';
const PROXY_BASE = "https://maruya-reactapp.vercel.app/api/proxy?url=";
const channelListEl = document.getElementById('channelList');
const searchInput = document.getElementById('search');
const nowTitle = document.getElementById('nowTitle');
const nowSub = document.getElementById('nowSub');
const epgList = document.getElementById('epgList');
const statusEl = document.getElementById('status');

let channels = window.IPTV_CHANNELS || [];

function status(msg){ statusEl.innerText=msg; console.log('[IPVTV]', msg); }
function escapeHtml(s){ return String(s||'').replace(/[&<>"'`=\/]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#47;','=':'&#61;','`':'&#96;'}[c])); }
function safeLogo(url){
  if(!url) return null;
  if(url.startsWith("http://")) url = url.replace("http://", "https://");
  return url;
}

function buildSidebar(){
  channelListEl.innerHTML = '';
  epgList.innerHTML = '<h4>Now & Next</h4>';
  channels.forEach((ch, idx) => {
    const item = document.createElement('div');
    item.className = 'channel-item';
    item.dataset.idx = idx;

    const logoWrap = document.createElement('div');
    logoWrap.className = 'ch-logo';
    if(ch.logo){
      const img = document.createElement('img');
      img.src = safeLogo(ch.logo);
      img.alt = ch.name;
      img.onerror = function(){
        this.onerror = null;
        this.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="320" height="180"><rect width="100%" height="100%" fill="%230b1b25"/><text x="50%" y="50%" fill="%239aa4b2" font-size="18" font-family="sans-serif" dominant-baseline="middle" text-anchor="middle">No logo</text></svg>';
      };
      logoWrap.appendChild(img);
    } else {
      logoWrap.textContent = ch.name.split(' ').slice(-1)[0];
    }

    const meta = document.createElement('div');
    meta.className = 'ch-meta';
    meta.innerHTML = `<div class="name">${escapeHtml(ch.name)}</div><div class="sub">${escapeHtml(ch.group||'Live')}${ch.license?' • DRM':''}</div>`;

    item.appendChild(logoWrap);
    item.appendChild(meta);
    item.onclick = () => selectChannel(idx);

    channelListEl.appendChild(item);
  });
  status(`Loaded ${channels.length} channels.`);
}

function selectChannel(idx){
  document.querySelectorAll('.channel-item').forEach(n=>n.classList.remove('active'));
  document.querySelector(`.channel-item[data-idx="${idx}"]`).classList.add('active');

  const ch = channels[idx];
  nowTitle.textContent = ch.name;
  nowSub.textContent = (ch.group?ch.group+' • ':'') + ch.mpd;

  const streamUrl = PROXY_BASE + encodeURIComponent(ch.mpd);
  const drmConfig = ch.license ? { widevine: { url: PROXY_BASE + encodeURIComponent(ch.license) } } : {};

  jwplayer("jwplayer-container").setup({
    file: streamUrl,
    type: "dash",
    drm: drmConfig,
    preload: "auto",
    width: "100%",
    height: "100%",
    stretching: "uniform",
    autostart: true
  });

  status(`Playing: ${ch.name}`);
}

searchInput.oninput = () => {
  const q = searchInput.value.toLowerCase();
  document.querySelectorAll('.channel-item').forEach(el => {
    const ch = channels[+el.dataset.idx];
    el.style.display = !q || ch.name.toLowerCase().includes(q) || (ch.group && ch.group.toLowerCase().includes(q)) ? 'flex' : 'none';
  });
};

buildSidebar();
</script>
</body>
</html>
